<!DOCTYPE html>
<html>
    {% load static %}
<head>
    <title>Search Movie</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible"
          content="IE=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1">
    <link rel="stylesheet"
          type="text/css"
          media="screen"
          href="{% static "bootstrap/css/bootstrap.min.css" %}" />
          <link rel="stylesheet"
          type="text/css"
          media="screen"
          href="{% static "bootstrap/css/bootstrap.min.css" %}" />

    <link rel="stylesheet"
          href="{% static "assets/icon-font/css/font-awesome.min.css" %}">
    <link rel="stylesheet"
      type="text/css"
      media="screen"
      href="{% static "assets/style.css" %}" />

    <script src="{% static "assets/js/jquery-3.3.1.js" %}"></script>

    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

    <script src="{% static "assets/js/index.js" %}"></script>
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
	<script>
	function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

	
        $(document).ready(function () {
			var csrftoken = getCookie('csrftoken');
	$.ajaxSetup({
		beforeSend: function(xhr, settings) {
			if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
				xhr.setRequestHeader("X-CSRFToken", csrftoken);
			}
		}
	});
			$('.badge-secondary').click(function(){
				$(this).toggleClass('active-keyword');
				$(this).toggleClass('nonactive-keyword');
			});
            $(".do_search").click(function () {
                    var query = $("#Searchfield").val();
                    var checkboxTitle = getCheckboxValue("#gridCheckTitle");
                    var checkboxKeyWords = getCheckboxValue("#gridCheckKeyWords");
                    var evaluationValues = getEvaluationValues();
                    var formerQueryInfo = getFormerQueryInfo();
                    var currentAssessor = getAssessor();
                    // send query contains [currentQuery, currentTitle, currentKeyWords, [formerQuery, formerTitle, formerKeywords], eachResult[rank, pointer, evalvalue], [currentAssessorName, currentAssessorGroup]]
                    query = JSON.stringify([query, checkboxTitle, checkboxKeyWords, formerQueryInfo, evaluationValues, currentAssessor]);
                    $("#sourcecontainer").html("<div class=\"row justify-content-md-center source-card\">\n" +
                        "\t<div class=\"col-sm-12 col-md-11\">\n" +
                        "\t\t<div class=\"card mb-3\">\n" +
                        "\t\t\t<div class=\"card-body\">\n" +
                        "\t\t\t\t<div class=\"row justify-content-center\">\n" +
                        "\t\t\t\t\t\t<img src=\"assets/img/load-gif.gif\" height=\"60\" width=\"60\">\n" +
                        "</div>\n" +
                        "<div class=\"row justify-content-center\">\n" +
                        "\t\t    <p>Zoeken...</p>\n" +
                        "\t\t\t\t</div>\n" +
                        "\t\t\t</div>\n" +
                        "\t\t</div>\n" +
                        "\t</div>\n" +
                        "</div>");
						$.post('/query/', query, function(response){
							$("#sourcecontainer").html(response);
						});

            });

            // for evaluation
            $(document).on("click",'.evaluationSlider', function(){
                $(this).addClass('evaluated');
            })

            $(document).on("click", "#search_button", function(){
                var title_search= $('#gridCheckTitle:checked').val();
                if (title_search!= "on"){
                    title_search= 'off';
                }

                var oldTitleClass = $('#gridCheckTitle').attr('class').split(" ")
                if(oldTitleClass.length > 1){
                    $('#gridCheckTitle').removeClass(oldTitleClass[1])
                }
                $('#gridCheckTitle').addClass('formerSearchTitle-'.concat(title_search))

                var keyword_search= $('#gridCheckKeyWords:checked').val();
                if (keyword_search!= "on"){
                    keyword_search= 'off';
                }

                var oldKeyWordsClass = $('#gridCheckKeyWords').attr('class').split(" ")
                if(oldKeyWordsClass.length > 1){
                    $('#gridCheckKeyWords').removeClass(oldKeyWordsClass[1])
                }
                $('#gridCheckKeyWords').addClass('formerSearchKeywords-'.concat(keyword_search))

                var formerQuery = $('#Searchfield').val()
                formerQuery = formerQuery.split(' ').join('_')

                var oldQueryClass = $('#Searchfield').attr('class').split(" ")
                if(oldQueryClass.length > 1){
                    $('#Searchfield').removeClass(oldQueryClass[1])
                }
                $('#Searchfield').addClass(formerQuery);
            });
        });

        function store_source(button, url, publish_date, title, snippet, type, outlet){

            let questionID = $('.do_search').attr('id');
            let parentDiv = $(button).parents(".jq-addsource");

            $.post( "{% static "database/Model_Source.php"%}", { func: "addToKnowledgeBase", question_id : questionID, url : url, publish_date : publish_date, title: title, snippet : snippet, type : type, outlet : outlet })
                .done(function( data ) {
                    if (!(data === 'success')){
                        alert(data)

                    } else {
                        // Successfull adding

                        $(parentDiv).html("<button class='btn btn-success jq-addtokb'><i class=\"fa fa-check-circle\" style='font-size:28px;'></i></button>");

                    }
                })
        }

        function getCheckboxValue(checkbox){
            var searchTerm = checkbox.concat(":checked");
            rawValue = $(searchTerm).val();
            var boolVal = "False"
            if(rawValue == "on"){
                boolVal = "True"
            }
            return boolVal
        }

        function getEvaluationValues(){
            var evaluationSliders = []
            rank = 0
            $('.evaluationSlider').each(function(){
                console.log("in evaluation term: ", $(this)[0])
                var evalID = $(this).attr('id').split("-")
                var evalRank = evalID[1]
                var evalPointer = evalID[2]
                if($(this).hasClass('evaluated')){
                    console.log("evaluation administred")
                    var evalValue = $(this)[0].value;
                }
                else{
                    var evalValue = -1;
                }
                //console.log("in getEvaluationValues, this: ", $(this)[0])
                //console.log("in getEvaluationValues, evalValue: ", evalValue)
                evaluationSliders.push([evalRank, evalPointer, evalValue]);
            });
            return evaluationSliders
        }

        function getFormerQueryInfo(){
            console.log("getFormerQueryInfo get class of element: ", $('#gridCheckTitle').attr('class').split(" "))
            var titleSearchList = $('#gridCheckTitle').attr('class').split(" ")
            var titleSearch = titleSearchList[titleSearchList.length-1]
            var keywordSearchList = $('#gridCheckKeyWords').attr('class').split(" ")
            var keywordSearch = keywordSearchList[keywordSearchList.length-1]
            var formerQueryList = $('#Searchfield').attr('class').split(" ")
            var formerQuery = formerQueryList[formerQueryList.length-1]
            console.log("getFormerQueryInfo in search_engine: ", formerQuery, titleSearch, keywordSearch)
            return [formerQuery, titleSearch, keywordSearch]
        }

        function getAssessor(){
            var assessorName = $('#accessor-form-name').val()
            var assessorGroup = $('#accessor-form-group').val()
            return [assessorName, assessorGroup]
        }

	</script>
</head>

<body class="page_search_engine">
    <!-- 此处显示demo图作为参考-->
    <div class="demopage hidden">
        <img src="{% static "assets/demo/search_engine.png" %}">
    </div>

    <div class="container-fluid my-layout d-flex flex-column">
        <div class="row justify-content-md-left removeleftmargin">
            </div>
        <div class="row flex-1">
            <!-- layout_content -->
            <div class="col-sm p-0 layout_content d-flex justify-content-center ">
                <div class="container-fluid">
                    <div id="header-element" class="row justify-content-md-center">
                        <div id="assessor-box">
                            <input type='text' id="accessor-form-name" class='form-control accessor-form' id='accessor-name' placeholder="Name Assessor">
                            <input type='text' id="accessor-form-group" class='form-control accessor-form' id='accessor-group' placeholder="Group Number">
                        </div>
                        <div class="col-sm-12 col-md-10">
                            <div class="title-box">
                                <h1>Another Movie Search Engine</h1>
                            </div>
                            <!-- search input -->
                            <form class="mt-3">
                                <div class="form-group row justify-content-center">
                                    <div class="input-group col-sm-12 col-md-8 col-lg-6">
                                        <div class="input-group-prepend clear">
                                            <div class="input-group-text">
                                                <i class="fa fa-search"
                                                   aria-hidden="true"></i>
                                            </div>
                                        </div>
                                        <input type="text"
                                               class="form-control start-up-class"
                                               id="Searchfield"
                                               placeholder="search your movie..">
                                    </div>   
                                 </div>
                                <div class="form-group row">
                                    <!----><div class="container">
                                        <div class="row justify-content-md-center">
                                            <div id="year-filter-block" class="col-lg-3 text-center">
                                               <div class="form-group mb-0">
                                                    <label><strong>Search in between years</strong></label>
                                                </div>
                                                <div class="row">
                                                    <span class="datumtitle">from:</span>
                                                </div>
                                                <div class="form-group row justify-content-center">
                                                    <div class="input-group col-sm-12">
                                                        <div class="input-group-prepend clear">
                                                            <div class="input-group-text">
                                                                <i class="fa fa-calendar-o"
                                                                   aria-hidden="true"></i>
                                                            </div>
                                                        </div>
                                                        <input type="text"
                                                               class="form-control"
                                                               id="datefrom"
                                                               placeholder="yyyy">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <span class="datumtitle">till:</span>
                                                </div>
                                                <div class="form-group row justify-content-center">
                                                    <div class="input-group col-sm-12">
                                                        <div class="input-group-prepend clear">
                                                            <div class="input-group-text">
                                                                <i class="fa fa-calendar-o"
                                                                   aria-hidden="true"></i>
                                                            </div>
                                                        </div>
                                                        <input type="text"
                                                               class="form-control"
                                                               id="dateto"
                                                               placeholder="yyyy">
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="query-rules" class="col-lg-3">
                                                <div class="form-group mb-0">
                                                    <label><strong>Search on:</strong></label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input formerSearchTitle-on"
                                                           type="checkbox"
                                                           id="gridCheckTitle" checked>
                                                    <label class="form-check-label"
                                                           for="gridCheckTitle">
                                                        Title
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input formerSearchKeywords-on"
                                                           type="checkbox"
                                                           id="gridCheckKeyWords" checked>
                                                    <label class="form-check-label"
                                                           for="gridCheckKeyWords">
                                                        Summary Search
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row justify-content-center">
                                    <div class="col-sm col-md-12 text-center">
                                        <button id="search_button" type="button" class="btn btn-primary bluebutton do_search"><i class="fa fa-search"
                                               aria-hidden="true"></i>
                                            Search Movies
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <hr class="col-md-9">
					<div class="sourcecontainer" id="sourcecontainer">
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>